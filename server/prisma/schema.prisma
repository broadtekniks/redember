generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id         String   @id
  name       String
  sku        String   @unique
  priceCents Int
  currency   String
  stock      Int
  description String?
  imageUrl   String?

  // UI metadata
  heatIntensity Int @default(50) // 0-100 slider
  heatProfile   String @default("standard") // gentle, standard, or inferno
  heatProfileDescriptions Json?

  // Variants support: categorize multiple SKUs (products) under one catalog product.
  categoryId    String? @map("groupId")
  variantName String?

  // Shipping metadata (for physical goods)
  requiresShipping Boolean @default(true)
  weightGrams Int?       // Legacy weight in grams
  weightOz    Float?     // Weight in ounces (for US products)
  weightG     Float?     // Weight in grams (decimal for precision)
  volumeMl    Float?     // Volume in milliliters (for liquids)
  lengthMm   Int?
  widthMm    Int?
  heightMm   Int?

  bestSeller Boolean  @default(false)
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  orders     Order[]
  images     ProductImage[]

  category   ProductCategory? @relation(fields: [categoryId], references: [id])
  variantValues ProductVariantValue[]
}

model ProductCategory {
  id          String   @id @default(cuid())
  name        String
  handle      String   @unique
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products      Product[]
  images        ProductImage[]
  variantTypes  ProductVariantType[]

  @@map("ProductGroup")
}

model Media {
  id        String   @id @default(cuid())
  url       String   @unique
  filename  String?
  size      Int?
  mimeType  String?
  alt       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productImages ProductImage[]

  @@index([url])
}

model ProductImage {
  id        String   @id @default(cuid())
  categoryId   String? @map("groupId")
  productId String?
  mediaId   String
  isMain    Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  category  ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  media     Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([categoryId, sortOrder])
  @@index([productId, sortOrder])
  @@index([mediaId])
}

model Order {
  id              String   @id @default(cuid())
  stripeSessionId String   @unique
  paymentIntentId String?
  status          String

  productId       String
  sku             String
  quantity        Int

  email           String?
  phone           String?

  shippingName    String?
  shippingLine1   String?
  shippingLine2   String?
  shippingCity    String?
  shippingState   String?
  shippingPostal  String?
  shippingCountry String?

  amountTotal     Int
  currency        String
  itemsJson       String

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  product         Product  @relation(fields: [productId], references: [id])

  @@index([createdAt])
}

model AdminUser {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([email])
}

model Session {
  sid    String  @id
  sess   Json
  expire DateTime

  @@map("session")
  @@index([expire], name: "IDX_session_expire")
}

model ShippingZone {
  id               String   @id @default(cuid())
  name             String   // "United States", "International", etc.
  countries        String[] // ISO country codes: ["US", "CA", "MX"]
  enabled          Boolean  @default(true)
  freeShippingMin  Int?     // Minimum order value in cents for free shipping
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  weightTiers      WeightTier[]

  @@index([enabled])
}

model WeightTier {
  id            String   @id @default(cuid())
  zoneId        String
  minWeightG    Int      // Minimum weight in grams (inclusive)
  maxWeightG    Int      // Maximum weight in grams (inclusive)
  rateCents     Int      // Shipping cost in cents
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  zone          ShippingZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId, minWeightG])
}

model StoreSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   // JSON string for complex values
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

model ProductVariantType {
  id           String   @id @default(cuid())
  categoryId      String? @map("groupId")
  // "global" variant types are not tied to a ProductCategory.
  // "category" variant types are legacy and scoped to a ProductCategory.
  scope        String   @default("global")
  // Indicates a built-in/default option type like Size/Color.
  isDefault    Boolean  @default(false)
  name         String   // e.g., "Size", "Color", "Material"
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  category     ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  values       ProductVariantValue[]

  @@index([categoryId, displayOrder])
  @@index([scope, displayOrder])
  @@unique([scope, name])
}

model ProductVariantValue {
  id            String   @id @default(cuid())
  productId     String
  variantTypeId String
  value         String   // e.g., "Small", "Red", "Cotton"
  createdAt     DateTime @default(now())

  product       Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantType   ProductVariantType @relation(fields: [variantTypeId], references: [id], onDelete: Cascade)

  @@unique([productId, variantTypeId, value])
  @@index([productId])
  @@index([variantTypeId])
}
